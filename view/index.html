<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Hono Chat</title>
  </head>
  <body>
    <h1>Hono Chat</h1>
    <button id="start-btn">Start New Conversation</button>

    <div id="conversation-view" style="display: none">
      <h3 id="conv-title">Conversation</h3>
      <div id="chat-container"></div>
      <br />
      <div id="input-area">
        <input
          type="text"
          id="message-input"
          placeholder="Type your message..."
        />
        <button id="send-btn">Send</button>
      </div>
    </div>

    <script>
      let conversationId = null;
      const chatContainer = document.getElementById("chat-container");
      const startBtn = document.getElementById("start-btn");
      const conversationView = document.getElementById("conversation-view");
      const messageInput = document.getElementById("message-input");
      const sendBtn = document.getElementById("send-btn");
      const convTitle = document.getElementById("conv-title");

      startBtn.addEventListener("click", async () => {
        try {
          const res = await fetch("/conversations", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              title: "New Chat " + new Date().toLocaleTimeString(),
            }),
          });
          const data = await res.json();
          if (res.ok) {
            conversationId = data._id;
            if (!conversationId && data.id) conversationId = data.id;

            console.log("Created conversation:", conversationId);
            convTitle.innerText = data.title || "Conversation";
            startBtn.style.display = "none";
            conversationView.style.display = "block";
            chatContainer.innerHTML = "";
          } else {
            alert("Error creating conversation: " + JSON.stringify(data));
          }
        } catch (err) {
          console.error(err);
          alert("Failed to start conversation");
        }
      });

      sendBtn.addEventListener("click", sendMessage);
      messageInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter") sendMessage();
      });

      async function sendMessage() {
        const text = messageInput.value.trim();
        if (!text || !conversationId) return;

        appendMessage("You: " + text);
        messageInput.value = "";

        try {
          const res = await fetch(
            `/conversations/${conversationId}/messages`,
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ content: text }),
            },
          );
          const data = await res.json();

          if (res.ok) {
            if (data.content && data.role === "ai") {
              appendMessage("AI: " + data.content);
            }
          } else {
            appendMessage(
              "Error sending message: " + (data.error || "Unknown"),
            );
          }
        } catch (err) {
          console.error(err);
          appendMessage("Error: Failed to send message");
        }
      }

      function appendMessage(text) {
        const div = document.createElement("div");
        div.textContent = text;
        chatContainer.appendChild(div);
      }
    </script>
  </body>
</html>
